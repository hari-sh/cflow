
<!DOCTYPE html>
  <html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Markmap</title>
    <link rel="stylesheet" href="../inc/treeview.css">
  </head>
  
  <body>
    <div class="container">
        <form>
        <input id="diaginput" type="text" placeholder="Search...">
        <button id="diagbtn" type="button">Search</button>
        </form>
    </div>
    <svg id="mindmap"></svg>
    <script src="../inc/d3.js"></script>
    <script src="../inc/d3-flextree.js"></script>
    <script src="../inc/treeview.js"></script>
    <script>
    const datajson = 
{
  "content": "a",
      "children": [
        {
          "content": "b",
          "children": [
            {
              "content": "c"
            }
          ]
        },
        {
          "content": "c"
        }
      ]
}
    </script>
    <script>
      const makeDataObj = (dobj) => {
        var dataObj = {};
        var stack = [dobj];
        while (stack?.length > 0){
          const curnObj = stack.pop();
          if(curnObj.children?.length > 0){
            dataObj[curnObj.content] = curnObj;
          }
          curnObj.children?.forEach(cobj => stack.push(cobj));
        }
        return dataObj;
      }
      const hashdata = makeDataObj(datajson);
      for(let hkey in hashdata)
      {
        var hval = hashdata[hkey];
        console.log(hval.content + "->" + hval.children?.map(o=>o.content));
      }

      const makeTreeObj = (obj) => {
        var dataObj = {};
        const stack = [obj];
        while (stack?.length > 0){
          var currentObj = stack.pop();
          currentObj.children?.forEach((cobj, ind, arr) => {
            if((cobj.content in hashdata) && (cobj != hashdata[cobj.content]))
            {
              arr[ind] = hashdata[cobj.content];
            }
            stack.push(arr[ind]);
          });
        }
      }

    </script>
    <script>
        document.getElementById("diagbtn").addEventListener("click", loadTreeData);
        document.getElementById('diaginput').addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault()
            loadTreeData();
          }
        });
        function loadTreeData() {
          const diagstr = document.getElementById('diaginput').value;
          document.getElementById('diaginput').value = "";
          treedata = {};
          if(diagstr in hashdata)
          {
            makeTreeObj(hashdata[diagstr]);
            treedata = hashdata[diagstr];
          }
          else
          {
              treedata = {"content": diagstr};
            console.log(diagstr);
          }
        }
        ((getMarkmap, getOptions, root, jsonOptions) => {
          const markmap = getMarkmap();
          window.mm?.destroy();
          window.mm = markmap.Markmap
          .create('svg#mindmap', 
                  (getOptions || markmap.deriveOptions)(jsonOptions), 
                  root);
        })(() => window.markmap, null, datajson, {})
    </script>
  </body>
</html>
